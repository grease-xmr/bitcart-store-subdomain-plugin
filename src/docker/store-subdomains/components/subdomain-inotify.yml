services:
  subdomain-inotify:
    image: alpine:3.19
    command:
      - /bin/sh
      - -c
      - |
        apk add --no-cache inotify-tools docker-cli
        PLUGIN_DIR="/datadir/plugin_data/store-subdomains"
        echo "Waiting for plugin data directory..."
        while [ ! -d "$$PLUGIN_DIR" ]; do
          sleep 5
        done
        echo "Plugin directory found, starting watch..."
        while inotifywait -e modify -e create "$$PLUGIN_DIR" 2>/dev/null; do
          echo "Map file changed, reloading nginx..."
          docker exec $${COMPOSE_PROJECT_NAME:-bitcart}-nginx-1 nginx -s reload || echo "Failed to reload nginx"
        done
    volumes:
      - "bitcart_datadir:/datadir:ro"
      - "/var/run/docker.sock:/var/run/docker.sock"
    restart: unless-stopped
    depends_on:
      - nginx
